import{a as be,Z as ge,ck as fe,cl as ye,r as o,cm as je,aM as ve,aN as Ne,cn as we,co as _e,y as m,j as e}from"./index-oHO_bMXB.js";const Ce=({children:j})=>{const[v,g]=o.useState(!1);return o.useEffect(()=>{const N=S=>{console.error("Error caught by boundary:",S),g(!0)};return window.addEventListener("error",N),()=>window.removeEventListener("error",N)},[]),v?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Something went wrong"}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Reload Page"})]})}):j},Ee=({role:j})=>{const v=be(),{user:g}=ge(r=>r.auth),[N,{isLoading:S}]=fe(),[M,{data:w,isLoading:ee}]=ye(),[_,P]=o.useState(null),{data:x,isLoading:re}=je({variantId:_,role:j||"admin"},{skip:!_||!(g!=null&&g.id)}),[s,p]=o.useState({full_name:"",phone:"",email:"",address:"",city:"",state:"",district:"",postal_code:"",product:"",variant:"",quantity:1,price_per_unit:"",selling_price:"",payment_method:"",transaction_id:"",purchase_date:new Date().toISOString().split("T")[0],notes:""}),[c,E]=o.useState(""),[te,h]=o.useState(!1),[d,F]=o.useState(null),[Se,se]=o.useState(null),[u,k]=o.useState(null),[l,b]=o.useState({}),f=o.useRef(null),{data:Q,error:q}=ve(),[L,G]=o.useState(""),{data:O,error:A}=Ne(L,{skip:!L}),{data:D,isLoading:z,error:I}=we(),[T,ae]=o.useState(""),{data:C,isLoading:H,error:V}=_e(T,{skip:!T});o.useEffect(()=>{q&&(console.error("States API error:",q),m.error("Failed to load states")),A&&console.error("Districts API error:",A),I&&(console.error("Products API error:",I),m.error("Failed to load products")),V&&(console.error("Variants API error:",V),m.error("Failed to load variants"))},[q,A,I,V]),o.useEffect(()=>{x&&_&&(x.success?(k(x),p(r=>({...r,price_per_unit:x.actual_price})),b(r=>({...r,price_per_unit:""}))):(m.error(x.error||"Failed to fetch price"),b(r=>({...r,price_per_unit:"Price not available for this variant"}))))},[x,_]);const U=(D==null?void 0:D.results)||[];o.useEffect(()=>(f.current&&clearTimeout(f.current),f.current=setTimeout(()=>{c.trim().length>2&&!d?(M(c.trim()).catch(r=>{console.error("Search error:",r),m.error("Failed to search customers")}),h(!0)):c.trim().length===0&&h(!1)},400),()=>{f.current&&clearTimeout(f.current)}),[c,M,d]);const le=r=>{r&&(F(r),E(r.full_name||""),h(!1),p(t=>({...t,full_name:r.full_name||"",phone:r.phone||"",email:r.email||"",address:r.address||"",city:r.city||"",state:r.state||"",district:r.district||"",postal_code:r.postal_code||""})),r.state&&G(r.state))},ne=r=>{const t=r.target.value,n=U.find(a=>a.rolebaseproductid===t);ae(t),se(n),k(null),P(null),p(a=>({...a,product:t,variant:"",price_per_unit:"",selling_price:""}))},oe=r=>{const t=r.target.value;p(n=>({...n,variant:t,price_per_unit:"",selling_price:""})),t?P(t):(k(null),P(null),b(n=>({...n,price_per_unit:""})))},i=r=>{const{name:t,value:n}=r.target;p(a=>({...a,[t]:n})),l[t]&&b(a=>({...a,[t]:""})),t==="full_name"&&n!==(d==null?void 0:d.full_name)&&(F(null),n.trim().length>2&&h(!0)),t==="state"&&G(n)},ie=()=>{F(null),E(""),h(!1),p(r=>({...r,full_name:"",phone:"",email:"",address:"",city:"",state:"",district:"",postal_code:""}))},ce=()=>{c.trim().length>2&&w&&w.length>0&&!d&&h(!0)},de=()=>{var t;const r={};return(t=s.full_name)!=null&&t.trim()||(r.full_name="Full name is required"),s.product||(r.product="Product selection is required"),s.variant||(r.variant="Variant selection is required"),(!s.quantity||s.quantity<1)&&(r.quantity="Valid quantity is required"),(!s.price_per_unit||parseFloat(s.price_per_unit)<=0)&&(r.price_per_unit="Valid buying price is required"),(!s.selling_price||parseFloat(s.selling_price)<=0)&&(r.selling_price="Valid selling price is required"),b(r),Object.keys(r).length===0},$=()=>{try{const r=parseFloat(s.quantity)||0,t=parseFloat(s.price_per_unit)||0;return(r*t).toFixed(2)}catch(r){return console.error("Calculation error:",r),"0.00"}},W=()=>{try{const r=parseFloat(s.quantity)||0,t=parseFloat(s.selling_price)||0;return(r*t).toFixed(2)}catch(r){return console.error("Calculation error:",r),"0.00"}},R=()=>{try{const r=parseFloat($())||0;return((parseFloat(W())||0)-r).toFixed(2)}catch(r){return console.error("Calculation error:",r),"0.00"}},Z=()=>{try{const r=parseFloat($())||0,t=parseFloat(R())||0;return r===0?"0.00":(t/r*100).toFixed(2)}catch(r){return console.error("Calculation error:",r),"0.00"}},[J,K]=o.useState(!1),ue=async r=>{var t,n;if(r.preventDefault(),!J){if(!de()){m.error("Please fix the errors in the form");return}K(!0);try{await N(s).unwrap(),m.success("Customer purchase created successfully!"),v(`/${j}/customer-purchases`)}catch(a){console.error("Create purchase error:",a);const he=((t=a==null?void 0:a.data)==null?void 0:t.message)||((n=a==null?void 0:a.data)==null?void 0:n.detail)||"Failed to create purchase";if(m.error(he),a!=null&&a.data){const Y={};Object.keys(a.data).forEach(y=>{y in s&&(Y[y]=Array.isArray(a.data[y])?a.data[y][0]:a.data[y])}),b(Y)}}finally{K(!1)}}},B=S||J,X=Array.isArray(w)?w:[],me=Array.isArray(Q)?Q:[],xe=Array.isArray(O)?O:[],pe=Array.isArray(C==null?void 0:C.results)?C.results:[];return e.jsx(Ce,{children:e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 py-6 cursor-default",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl shadow-lg mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})}),e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"Create Customer Purchase"}),e.jsx("p",{className:"mt-2 text-lg text-gray-600 max-w-2xl mx-auto",children:"Record a new customer purchase with real-time pricing and profit calculations"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4",children:e.jsx("h2",{className:"text-xl font-bold text-white",children:"New Purchase Order"})}),e.jsxs("form",{onSubmit:ue,className:"p-6 space-y-8",children:[e.jsxs("section",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-2 h-8 bg-gradient-to-b from-blue-600 to-indigo-600 rounded-full"}),e.jsx("h3",{className:"text-xl font-bold text-gray-800",children:"Customer Information"})]}),e.jsxs("div",{className:"bg-blue-50 rounded-xl p-4 border border-blue-200",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-3",children:"üîç Search Existing Customer"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:c,onChange:r=>E(r.target.value),onFocus:ce,className:"w-full px-4 py-3 text-base border-2 border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white",placeholder:"Type customer name, phone, or email to search..."}),c&&e.jsx("button",{type:"button",onClick:ie,className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors cursor-pointer",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),te&&!d&&e.jsx("div",{className:"absolute z-20 w-full mt-2 bg-white border-2 border-blue-200 rounded-xl shadow-2xl max-h-60 overflow-y-auto",children:ee?e.jsxs("div",{className:"px-4 py-3 text-sm text-gray-500 flex items-center space-x-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-blue-600 border-t-transparent"}),e.jsx("span",{children:"Searching customers..."})]}):X.length>0?X.map((r,t)=>e.jsxs("div",{onClick:()=>le(r),className:"px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors",children:[e.jsx("div",{className:"font-semibold text-gray-900",children:r.full_name}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1 flex flex-wrap gap-2",children:[r.phone&&e.jsxs("span",{children:["üìû ",r.phone]}),r.email&&e.jsxs("span",{children:["‚úâÔ∏è ",r.email]}),r.city&&e.jsxs("span",{children:["üèôÔ∏è ",r.city]})]})]},r.id||t)):e.jsx("div",{className:"px-4 py-3 text-sm text-gray-500",children:c.trim().length>2?"No customers found":"Type at least 3 characters to search"})})]}),e.jsx("p",{className:"text-xs text-blue-600 mt-2 font-medium",children:d?"Customer selected ‚úì":"Search for existing customers or enter new customer details below"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[{label:"Full Name *",name:"full_name",type:"text",placeholder:"Enter customer full name",colSpan:"md:col-span-2 lg:col-span-3"},{label:"Phone Number",name:"phone",type:"tel",placeholder:"Enter phone number"},{label:"Email Address",name:"email",type:"email",placeholder:"Enter email address"},{label:"Address",name:"address",type:"text",placeholder:"Enter complete address",colSpan:"md:col-span-2 lg:col-span-3"},{label:"City",name:"city",type:"text",placeholder:"Enter city"},{label:"State",name:"state",type:"select",options:me},{label:"District",name:"district",type:"select",options:xe,disabled:!L},{label:"Postal Code",name:"postal_code",type:"text",placeholder:"Enter postal code"}].map(r=>{var t;return e.jsxs("div",{className:r.colSpan||"",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:r.label}),r.type==="select"?e.jsxs("select",{name:r.name,value:s[r.name]||"",onChange:i,disabled:r.disabled,className:`w-full px-4 py-3 text-sm border-2 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all cursor-pointer bg-white ${l[r.name]?"border-red-300":"border-gray-200"}`,children:[e.jsxs("option",{value:"",children:["Select ",r.label.split(" ")[0]]}),(t=r.options)==null?void 0:t.map(n=>e.jsx("option",{value:n.id,children:n.name},n.id))]}):e.jsx("input",{type:r.type,name:r.name,value:s[r.name]||"",onChange:i,className:`w-full px-4 py-3 text-sm border-2 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all ${l[r.name]?"border-red-300":"border-gray-200"}`,placeholder:r.placeholder,required:r.label.includes("*")}),l[r.name]&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:l[r.name]})]},r.name)})})]}),e.jsxs("section",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-2 h-8 bg-gradient-to-b from-green-600 to-emerald-600 rounded-full"}),e.jsx("h3",{className:"text-xl font-bold text-gray-800",children:"Purchase Details"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Product *"}),e.jsxs("select",{name:"product",value:s.product||"",onChange:ne,className:`w-full px-4 py-3 text-sm border-2 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all cursor-pointer bg-white ${l.product?"border-red-300":"border-gray-200"}`,required:!0,disabled:z,children:[e.jsx("option",{value:"",children:"Select Product"}),U.map(r=>e.jsxs("option",{value:r.rolebaseproductid,children:[r.name," - ‚Çπ",r.price]},r.rolebaseproductid))]}),l.product&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:l.product}),z&&e.jsxs("div",{className:"text-xs text-gray-500 mt-2 flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-2 border-blue-600 border-t-transparent mr-2"}),"Loading products..."]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Variant *"}),e.jsxs("select",{name:"variant",value:s.variant||"",onChange:oe,className:`w-full px-4 py-3 text-sm border-2 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all cursor-pointer bg-white ${l.variant?"border-red-300":"border-gray-200"}`,required:!0,disabled:!T||H,children:[e.jsx("option",{value:"",children:"Select Variant"}),pe.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]}),l.variant&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:l.variant}),H&&e.jsxs("div",{className:"text-xs text-gray-500 mt-2 flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-2 border-blue-600 border-t-transparent mr-2"}),"Loading variants..."]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Quantity *"}),e.jsx("input",{type:"number",name:"quantity",value:s.quantity||1,onChange:i,min:"1",className:`w-full px-4 py-3 text-sm border-2 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all cursor-pointer ${l.quantity?"border-red-300":"border-gray-200"}`,required:!0}),l.quantity&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:l.quantity})]}),e.jsxs("div",{className:"space-y-4 lg:col-span-2",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Buying Price Per Unit (‚Çπ) *"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",name:"price_per_unit",value:s.price_per_unit||"",onChange:i,step:"0.01",min:"0",className:`w-full px-4 py-3 text-sm border-2 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-gray-50 pr-12 ${l.price_per_unit?"border-red-300":"border-gray-200"}`,placeholder:"0.00",disabled:!0}),re&&e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-blue-600 border-t-transparent"})})]}),l.price_per_unit?e.jsx("p",{className:"text-red-500 text-xs mt-1",children:l.price_per_unit}):e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:u?"Auto-fetched based on variant":"Select variant to auto-fetch price"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Selling Price Per Unit (‚Çπ) *"}),e.jsx("input",{type:"number",name:"selling_price",value:s.selling_price||"",onChange:i,step:"0.01",min:"0",className:`w-full px-4 py-3 text-sm border-2 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all ${l.selling_price?"border-red-300":"border-gray-200"}`,placeholder:"0.00",required:!0}),l.selling_price&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:l.selling_price}),!l.selling_price&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Enter your selling price to customer"})]})]}),u&&e.jsxs("div",{className:"bg-green-50 border-2 border-green-200 rounded-xl p-4",children:[e.jsx("h4",{className:"text-sm font-semibold text-green-800 mb-2",children:"Price Breakdown"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Base Price:"}),e.jsxs("div",{className:"font-semibold",children:["‚Çπ",u.price]})]}),u.discount>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Discount:"}),e.jsxs("div",{className:"font-semibold text-green-600",children:[u.discount,"%"]})]}),u.gst_percentage>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"GST:"}),e.jsxs("div",{className:"font-semibold",children:[u.gst_percentage,"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Final Price:"}),e.jsxs("div",{className:"font-semibold text-blue-600",children:["‚Çπ",u.actual_price]})]})]})]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 border-2 border-blue-200",children:[e.jsx("h4",{className:"text-lg font-bold text-gray-800 mb-4",children:"üí∞ Financial Summary"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[{label:"Total Cost",value:`‚Çπ${$()}`,color:"text-blue-600"},{label:"Total Revenue",value:`‚Çπ${W()}`,color:"text-green-600"},{label:"Profit",value:`‚Çπ${R()}`,color:R()>=0?"text-green-600":"text-red-600"},{label:"Profit %",value:`${Z()}%`,color:Z()>=0?"text-green-600":"text-red-600"}].map((r,t)=>e.jsxs("div",{className:"text-center bg-white rounded-xl p-4 shadow-sm border border-gray-200",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-600 mb-1",children:r.label}),e.jsx("p",{className:`text-2xl font-bold ${r.color}`,children:r.value})]},t))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Payment Method"}),e.jsxs("select",{name:"payment_method",value:s.payment_method||"",onChange:i,className:"w-full px-4 py-3 text-sm border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all cursor-pointer bg-white",children:[e.jsx("option",{value:"",children:"Select Payment Method"}),e.jsx("option",{value:"cash",children:"üíµ Cash"}),e.jsx("option",{value:"card",children:"üí≥ Card"}),e.jsx("option",{value:"upi",children:"üì± UPI"}),e.jsx("option",{value:"bank_transfer",children:"üè¶ Bank Transfer"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Transaction ID"}),e.jsx("input",{type:"text",name:"transaction_id",value:s.transaction_id||"",onChange:i,className:"w-full px-4 py-3 text-sm border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all",placeholder:"Enter transaction ID"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Purchase Date"}),e.jsx("input",{type:"date",name:"purchase_date",value:s.purchase_date,onChange:i,className:"w-full px-4 py-3 text-sm border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Notes"}),e.jsx("textarea",{name:"notes",value:s.notes||"",onChange:i,rows:3,className:"w-full px-4 py-3 text-sm border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none transition-all",placeholder:"Additional notes or comments about this purchase..."})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:()=>v(-1),disabled:B,className:"flex-1 px-6  py-4 border-2 border-gray-300 text-gray-700 bg-white rounded-xl hover:bg-gray-50 font-semibold transition-all duration-200 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",children:"‚Üê Cancel"}),e.jsx("button",{type:"submit",disabled:B,className:"flex-1 px-6 cursor-pointer py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl hover:from-blue-700 hover:to-indigo-700 font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:hover:shadow-lg",children:B?e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx("div",{className:"animate-spin cursor-pointer rounded-full h-5 w-5 border-2 border-white border-t-transparent"}),e.jsx("span",{children:"Creating Purchase..."})]}):"‚úÖ Create Purchase"})]})]})]})]})})})};export{Ee as default};
